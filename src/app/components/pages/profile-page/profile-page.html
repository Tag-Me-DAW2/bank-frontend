<header-component></header-component>
<div class="profile-page">
    <div class="profile-page__general-wrapper">
        <h1 class="profile-page__header-title">MIS CUENTAS</h1>
        <div class="profile-page__account-wrapper">
            <div class="profile-page__account-container">
                <embla-slider direction="horizontal" (selectedItemIndex)="onAccountSelected($event)">
                    @for (account of accounts; track $index) {
                    <a class="profile-page__account-card"
                        [class.profile-page__account-card--single]="accounts.length === 1">
                        <div class="profile-page__account-card-header">
                            <span class="profile-page__account-label">Cuenta</span>
                            <span class="profile-page__account-number">{{ account.iban }}</span>
                        </div>
                        <div class="profile-page__account-balance-section">
                            <span class="profile-page__balance-label">Saldo Disponible</span>
                            <span class="profile-page__account-balance">{{ account.balance | currency }}</span>
                        </div>

                        <div class="profile-page__account-movements">
                            <div class="profile-page__movements-header">
                                <span class="profile-page__movements-title">Movimientos Recientes</span>
                                <a class="profile-page__movements-see-more"
                                    [routerLink]="['/bank/movements/', account.id]">
                                    Ver todo <i class="bx bx-right-arrow-alt"></i>
                                </a>
                            </div>

                            <div class="profile-page__accounts-cards-wrapper">
                                @for (movement of account.movements.slice(0, 4); track $index) {
                                <a class="profile-page__movement-item" [routerLink]="['/bank/movements/', account.id]"
                                    [queryParams]="{ movementId: movement.id }">
                                    <span class="profile-page__movement-type">
                                        <i class="bx" [ngClass]="{
                                            'bx-trending-up deposit': movement.type == 'DEPOSIT',
                                            'bx-trending-down withdrawal': movement.type == 'WITHDRAWAL'
                                        }"></i>
                                    </span>
                                    <div class="profile-page__movement-central-info">
                                        <span class="profile-page__movement-description">
                                            @if (movement.type == 'DEPOSIT') { Depósito } @else { Retiro }
                                        </span>
                                        <div class="profile-page__movement-meta">
                                            <span class="profile-page__movement-origin">
                                                @switch (movement.origin) {
                                                @case ('BANK_ACCOUNT') { <i class="bx bx-building"></i> Cuenta }
                                                @case ('BANK_CARD') { <i class="bx bx-credit-card"></i> Tarjeta }
                                                @case ('DOMICILIATION') { <i class="bx bx-file"></i> Domiciliación }
                                                }
                                            </span>
                                            <span class="profile-page__movement-date">
                                                {{ movement.date | date:'d MMM y' }}
                                            </span>
                                        </div>
                                    </div>
                                    <span class="profile-page__movement-amount" [ngClass]="{
                                        'deposit': movement.type == 'DEPOSIT',
                                        'withdrawal': movement.type == 'WITHDRAWAL'
                                    }">
                                        {{ movement.type == 'DEPOSIT' ? '+' : '-' }}{{ movement.amount | currency }}
                                    </span>
                                </a>
                                }
                                @if (account.movements.length === 0) {
                                <div class="profile-page__no-movements">
                                    <i class="bx bx-info-circle"></i>
                                    <span>Sin movimientos</span>
                                </div>
                                }
                            </div>
                        </div>
                    </a>
                    }
                </embla-slider>
            </div>
            @if (selectedAccount) {
            <div class="profile-page__card-wrapper">
                <h2 class="profile-page__card-section-title">
                    <i class="bx bx-credit-card"></i> Mis Tarjetas
                </h2>
                <embla-slider #cardSlider direction="vertical">
                    @for (card of selectedAccount.cards; track $index) {
                    <div class="profile-page__card-flip-container" [class.flipped]="isCardFlipped(card.id)"
                        (click)="toggleCardFlip(card.id, $event)">

                        <!-- Card Front -->
                        <a class="profile-page__card-container profile-page__card-front"
                            [routerLink]="['/bank/movements/', selectedAccount.id]" [queryParams]="{ cardId: card.id }">
                            <div class="profile-page__card-top">
                                <div class="profile-page__card-chip">
                                    <i class="bx bxs-chip"></i>
                                </div>
                                <div class="profile-page__card-contactless">
                                    <i class="bx bx-wifi"></i>
                                </div>
                            </div>
                            <div class="profile-page__card-number">{{ card.number }}</div>
                            <div class="profile-page__card-bottom">
                                <div class="profile-page__card-bottom-info">
                                    <div class="profile-page__card-label">Titular</div>
                                    <div class="profile-page__card-holder">{{ card.fullName }}</div>
                                </div>
                                <span class="profile-page__card-brand">VISA</span>
                            </div>
                            <button class="profile-page__card-flip-btn" type="button"
                                title="Ver CVV y fecha de expiración" (click)="toggleCardFlip(card.id, $event)">
                                <i class="bx bx-show"></i>
                            </button>
                        </a>

                        <!-- Card Back -->
                        <div class="profile-page__card-container profile-page__card-back">
                            <div class="profile-page__card-magnetic-strip"></div>
                            <div class="profile-page__card-back-content">
                                <div class="profile-page__card-security-info">
                                    <div class="profile-page__card-data-row">
                                        <div class="profile-page__card-data-item">
                                            <span class="profile-page__card-data-label">CVV</span>
                                            <span class="profile-page__card-data-value">{{ getCardDetail(card.id)?.cvv
                                                || '•••' }}</span>
                                        </div>
                                        <div class="profile-page__card-data-item">
                                            <span class="profile-page__card-data-label">Válida hasta</span>
                                            <span class="profile-page__card-data-value">{{
                                                formatExpirationDate(getCardDetail(card.id)?.expirationDate!) }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-page__card-back-footer">
                                    <span class="profile-page__card-brand-back">VISA</span>
                                    <div class="profile-page__card-flip-hint">
                                        <i class="bx bx-revision"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                    @if (selectedAccount.cards.length === 0) {
                    <div class="profile-page__no-cards">
                        <i class="bx bx-credit-card-front"></i>
                        <span>Sin tarjetas vinculadas</span>
                    </div>
                    }
                </embla-slider>
            </div>
            }
        </div>
        @if (selectedAccount) {
        <hr class="profile-page__separator-bar">
        <stats-page [accountId]="selectedAccount.id"></stats-page>
        }
    </div>
</div>